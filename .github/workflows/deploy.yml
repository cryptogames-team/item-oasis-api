name: deploy

on:
    push:
        branches: 
            - "main"
jobs:
    checkout:
        runs-on: [self-hosted]
        steps:
            - name: ðŸ›’ Checkout
              uses: actions/checkout@v2

    build:
        needs: checkout
        if: github.ref == 'refs/heads/main'
        runs-on: [self-hosted]
        steps:
        #   - name: Use Node.js 16.x
        #     uses: actions/setup-node@v1
        #     with:
        #       node-version: 16.x
            # - name: ðŸš€ with_lite_build
            #   run: |
            #     echo 'ëŸ¬ë„ˆí…ŒìŠ¤íŠ¸ss'

          - name: Install dependencies
            run: npm install

          - name: build dependencies
            run: npm run build  
              
          - name: create env file
            run: |
                touch ./dist/.env
                    echo HOST = '43.200.195.138' >> ./dist/.env
                    echo DB_HOST = '43.200.195.138' >> ./dist/.env
                    echo ELASTIC_HOST = 'http://221.148.25.234:9200' >> ./dist/.env
                    echo DB_PORT = 3306 >> ./dist/.env
                    echo REDIS_PORT = 6379 >> ./dist/.env
                    echo DB_USERNAME = 'crypto-data' >> ./dist/.env
                    echo DB_PASSWD = '1207' >> ./dist/.env
                    echo DB_DATABASE = 'item_oasis' >> ./dist/.env
                    echo AWS_ACECSS_KEY_ID = 'AKIA25QHJSJLUFOJS6UC' >> ./dist/.env
                    echo AWS_SECRET_ACCESS_KEY = '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' >> ./dist/.env
                    echo AWS_BUCKET_REGION = 'ap-northeast-2' >> ./dist/.env
                    echo AWS_BUCKET_NAME = 'crypto-games-s3' >> ./dist/.env
                    echo JWT_SCRET_KEY = 'itemoasisjwtscretkey' >> ./dist/.env
                    echo REFRESH_JWT_SCRET_KEY = 'itemoasisrefreshjwtscretkey' >> ./dist/.env
                    echo PORT = '1207' >> ./dist/.env
                    echo CONTRACT_PRIVATE_KEY = '5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3' >> ./dist/.env
                    echo CONTRACT_ACCOUNT_NAME = 'eosio.item' >> ./dist/.env
                    
          - name: Copy new server to html
            run: |
                cp -R ./ /var/www/html/item-oasis-api
        #   - name: Stop old server (ignore error)
        #     run: |
        #       killall -9 node || true
      
        #   - name: Remove old server in ~/soruce (ignore error)
        #     run: |
        #       rm -rf ~/source || true
      
        #   - name: Copy new server to ~/soruce
        #     run: |
        #       mkdir -p ~/source
        #       cp -R ./ ~/source
              
        #   - name: Run new server (in background)
        #     env:
        #       RUNNER_TRACKING_ID: ""
        #     run: |
        #       cd ~/source
        #       nohup npm run start </dev/null >/dev/null 2>&1 &